{% extends 'base.html' %}
{% block title %}Editar Venta{% endblock %}

{% block content %}
<h2>Editar Venta #{{ venta.id }} ‚Äì {{ venta.numero_documento }}</h2>

<form method="post">
  {% csrf_token %}
  <div class="card mb-3">
    <div class="card-body">
      {{ form.as_p }}
    </div>
  </div>

  <h5>Detalle</h5>
  {{ formset.management_form }}

  <!-- Encabezados tipo columna -->
  <div class="row fw-bold border-bottom pb-2 mb-2 text-center">
    <div class="col-md-5">Producto</div>
    <div class="col-md-2">Cantidad</div>
    <div class="col-md-2">Precio Unitario</div>
    <div class="col-md-2">Subtotal</div>
    <div class="col-md-1">Eliminar</div>
  </div>



{% for form in formset %}
  <div class="card mb-2 detalle-item">
    <div class="card-body row align-items-center text-center">
      {{ form.id }}  <!-- üîπ Campo oculto obligatorio -->
      {{ form.venta }}  <!-- üîπ Campo oculto obligatorio (a veces lo incluye el formset) -->

      <div class="col-md-5">{{ form.producto }}</div>
      <div class="col-md-2">{{ form.cantidad }}</div>
      <div class="col-md-2">{{ form.precio_unitario }}</div>
      <div class="col-md-2 subtotal text-muted">Q 0.00</div>
      <div class="col-md-1">{{ form.DELETE }}</div>
    </div>
  </div>
{% endfor %}



</form>
{% endblock %}


{% block extra_js %}
<style>
  #total-general {
    text-align: right;
    font-size: 1.1rem;
    margin-top: 1rem;
  }
  #btn-agregar-producto {
    display: block;
    margin: 1rem auto;
  }

  /* Bot√≥n rojo con ‚ÄúX‚Äù */
  .btn-eliminar {
    background-color: #dc3545;
    color: #fff;
    border: none;
    border-radius: 6px;
    width: 32px;
    height: 32px;
    font-weight: 700;
    font-size: 18px;
    line-height: 1;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    justify-content: center;
  }
  .btn-eliminar:hover { background-color: #bb2d3b; }
</style>

<script>
document.addEventListener("DOMContentLoaded", function() {
  console.log("‚úÖ Ventas: script activo (editar con bot√≥n X y c√°lculos)");

  const form = document.querySelector("main form");

  // --- FOOTER con total + botones ---
  let footer = document.createElement("div");
  footer.id = "acciones-footer";
  footer.className = "text-center mt-4";
  form.appendChild(footer);

  let totalDiv = document.createElement("div");
  totalDiv.id = "total-general";
  totalDiv.className = "alert alert-info mt-3";
  footer.appendChild(totalDiv);

  const addButton = document.createElement("button");
  addButton.id = "btn-agregar-producto";
  addButton.type = "button";
  addButton.className = "btn btn-outline-primary mx-2";
  addButton.innerText = "‚ûï Agregar otro producto";
  footer.appendChild(addButton);

  const saveBtn = document.createElement("button");
  saveBtn.type = "submit";
  saveBtn.className = "btn btn-success mx-2";
  saveBtn.innerText = "Guardar cambios";
  footer.appendChild(saveBtn);

  const cancelBtn = document.createElement("a");
  cancelBtn.href = "{% url 'ventas:ventas_list' %}";
  cancelBtn.className = "btn btn-secondary mx-2";
  cancelBtn.innerText = "Cancelar";
  footer.appendChild(cancelBtn);

  // --- C√ÅLCULOS ---
  function calcularTotales() {
    let total = 0.0;
    const rows = document.querySelectorAll(".card-body");

    rows.forEach((row) => {
      const cantidadInput = row.querySelector("input[name$='cantidad']");
      const precioInput = row.querySelector("input[name$='precio_unitario']");
      if (cantidadInput && precioInput && row.offsetParent !== null) {
        const cantidad = parseFloat(cantidadInput.value) || 0;
        const precio = parseFloat(precioInput.value) || 0;
        const subtotal = cantidad * precio;
        total += subtotal;

        let subtotalSpan = row.querySelector(".subtotal");
        if (!subtotalSpan) {
          subtotalSpan = document.createElement("div");
          subtotalSpan.className = "subtotal mt-1 text-muted";
          row.appendChild(subtotalSpan);
        }
        subtotalSpan.innerText = `Subtotal: Q ${subtotal.toFixed(2)}`;
      }
    });

    totalDiv.innerHTML = `<strong>Total General: Q ${total.toFixed(2)}</strong>`;
  }

  // --- Precio autom√°tico ---
  function configurarSelectsProducto(context=document) {
    const productoSelects = context.querySelectorAll("select[name$='producto']");
    productoSelects.forEach((select) => {
      select.addEventListener("change", function() {
        const productoId = this.value;
        const parentCard = this.closest(".card-body");
        const precioInput = parentCard?.querySelector("input[name$='precio_unitario']");
        if (productoId && precioInput) {
          fetch(`/ventas/obtener_precio_producto/?producto_id=${productoId}`)
            .then(r => r.json())
            .then(data => { precioInput.value = data.precio.toFixed(2); calcularTotales(); })
            .catch(err => console.error("Error al obtener precio:", err));
        }
      });
    });
  }

  // --- Reemplaza checkbox DELETE por bot√≥n ‚ÄúX‚Äù ---
  function activarBotonEliminar(context=document) {
    const filas = context.querySelectorAll(".card-body");
    filas.forEach(fila => {
      const check = fila.querySelector("input[name$='DELETE']");
      if (check && !fila.querySelector(".btn-eliminar")) {
        check.style.display = "none";
        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = "btn-eliminar";
        btn.innerText = "√ó";
        check.insertAdjacentElement("afterend", btn);
      }
    });
  }

  // --- Delegaci√≥n de evento de eliminar ---
  form.addEventListener("click", function(e) {
    const btn = e.target.closest(".btn-eliminar");
    if (!btn) return;
    e.preventDefault();

    const body = btn.closest(".card-body");
    const check = body?.querySelector("input[name$='DELETE']");
    if (check) check.checked = true;

    const card = btn.closest(".card.mb-2") || btn.closest(".detalle-item") || body;
    if (card) card.style.display = "none";

    calcularTotales();
  });

  // --- Recalcular al editar campos ---
  document.addEventListener("input", function(e) {
    if (e.target.name && (e.target.name.endsWith("cantidad") || e.target.name.endsWith("precio_unitario"))) {
      calcularTotales();
    }
  });

  // --- Inicializaci√≥n ---
  configurarSelectsProducto();
  activarBotonEliminar();
  calcularTotales(); // üí° recalcula al cargar, mostrando subtotales iniciales

  // --- Agregar nuevo producto ---
  addButton.addEventListener("click", function() {
    const totalForms = document.querySelector("#id_detalles-TOTAL_FORMS");
    const formCount = parseInt(totalForms.value);
    const firstForm = document.querySelector(".card.mb-2");
    if (!firstForm) { alert(" No se encontr√≥ el bloque base del detalle de venta."); return; }

    const newForm = firstForm.cloneNode(true);

    newForm.querySelectorAll("input, select").forEach(el => {
      if (el.type !== "hidden") el.value = "";
      if (el.name && el.name.endsWith("DELETE")) el.checked = false;
    });
    newForm.querySelectorAll(".btn-eliminar").forEach(b => b.remove());

    newForm.innerHTML = newForm.innerHTML.replaceAll(`detalles-0`, `detalles-${formCount}`);
    form.insertBefore(newForm, footer);

    totalForms.value = formCount + 1;

    configurarSelectsProducto(newForm);
    activarBotonEliminar(newForm);
    calcularTotales();

    console.log(" Nueva l√≠nea agregada (editar)");
  });
});
</script>
{% endblock %}
