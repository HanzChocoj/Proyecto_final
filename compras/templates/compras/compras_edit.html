{% extends 'base.html' %}
{% block title %}Editar compra{% endblock %}
{% block content %}
<h2>Editar compra: {{ compra.numero_factura }}</h2>

<form method="post" id="compraForm">
  {% csrf_token %}
  
  <!-- Encabezado de compra -->
  <div class="card mb-3">
    <div class="card-body">
      <div class="row g-3">
        
        <!-- Fecha (solo lectura) -->
        <div class="col-md-3">
          <label class="form-label">Fecha de compra</label>
          <input type="text" class="form-control" value="{{ compra.fecha|date:'d/m/Y' }}" readonly>
        </div>

        <!-- Proveedor (nuevo campo relacional) -->
        <div class="col-md-5">
          <label class="form-label">Proveedor</label>
          {{ form.proveedor_fk }}
        </div>

        <!-- No. Factura -->
        <div class="col-md-4">
          <label class="form-label">No. Factura</label>
          {{ form.numero_factura }}
        </div>

        <!-- Encargado -->
        <div class="col-md-6">
          <label class="form-label">Encargado de compra</label>
          {{ form.encargado }}
        </div>

        <!-- Total (solo lectura) -->
        <div class="col-md-6">
          <label class="form-label">Total (Q)</label>
          <input type="text" class="form-control" value="{{ compra.total|floatformat:2 }}" readonly>
        </div>

        <!-- Observaciones -->
        <div class="col-md-12 mt-2">
          <label class="form-label">Observaciones</label>
          {{ form.observaciones }}
        </div>

      </div>
    </div>
  </div>

  <!-- Detalles de compra -->
  <h4>Detalles de compra</h4>

  <div class="table-responsive">
    <table class="table table-bordered align-middle" id="formset_area">
      <thead class="table-light">
        <tr>
          <th style="width:45%">Producto</th>
          <th style="width:20%">Cantidad</th>
          <th style="width:20%">Costo unitario</th>
          <th style="width:10%">Acción</th>
        </tr>
      </thead>
      <tbody>
        {{ formset.management_form }}
        {% for form in formset %}
        <tr class="formset_row">
          {{ form.id }}  <!-- Campo oculto -->
          <td>{{ form.producto }}</td>
          <td>{{ form.cantidad }}</td>
          <td>{{ form.costo_unitario }}</td>
          <td class="text-center">
            <button type="button" class="btn btn-danger btn-sm remove-row">✖</button>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <button type="button" id="add-row" class="btn btn-secondary mb-3">+ Agregar línea</button><br>

  <button type="submit" class="btn btn-success">Guardar cambios</button>
  <a href="{% url 'compras:compras_list' %}" class="btn btn-secondary">Cancelar</a>

  {% if form.errors %}
  <div class="alert alert-danger mt-3">
    <strong>Errores en el formulario:</strong> {{ form.errors }}
  </div>
  {% endif %}

  {% if formset.non_form_errors %}
  <div class="alert alert-danger mt-3">
    <strong>Errores en el detalle:</strong> {{ formset.non_form_errors }}
  </div>
  {% endif %}
</form>



{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
  const addRowBtn = document.getElementById('add-row');
  const formsetArea = document.querySelector('#formset_area tbody');
  const totalForms = document.querySelector('#id_detalles-TOTAL_FORMS');

  addRowBtn.addEventListener('click', function() {
    const currentFormCount = parseInt(totalForms.value);
    const newFormIndex = currentFormCount;

    // Clonar la primera fila (no la última)
    const firstRow = document.querySelector('.formset_row');
    const newRow = firstRow.cloneNode(true);

    // Limpiar todos los campos (inputs y selects)
    newRow.querySelectorAll('input, select').forEach(input => {
      input.name = input.name.replace(`-${currentFormCount - 1}-`, `-${newFormIndex}-`);
      input.id = input.id.replace(`-${currentFormCount - 1}-`, `-${newFormIndex}-`);

      // Vaciar valores
      if (input.tagName === 'INPUT') {
        input.value = '';
      } else if (input.tagName === 'SELECT') {
        input.selectedIndex = 0; // selecciona el primer elemento (vacío)
      }
    });

    // Quitar cualquier id oculto de registro existente
    const hiddenId = newRow.querySelector('input[name$="-id"]');
    if (hiddenId) hiddenId.value = '';

    // Agregar la nueva fila al DOM
    formsetArea.appendChild(newRow);

    // Actualizar total de formularios
    totalForms.value = newFormIndex + 1;
  });

  // Eliminar fila
  formsetArea.addEventListener('click', function(e) {
    if (e.target.classList.contains('remove-row')) {
      e.target.closest('.formset_row').remove();
    }
  });
});
</script>

{% endblock %}
{% endblock %}
